<!DOCTYPE html>
<!-- Migrated from main/home.html -->
<html lang="en" data-theme="neo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DcTalk • Home</title>
    <link rel="stylesheet" href="/main/theme.css">
    <style>
        :root { --bg-900:#1f2124; --bg-800:#282b30; --bg-700:#30343a; --text:#e6e7e8; --muted:#b2b4b7; --brand:#5865F2; --brand-700:#4752c4; --ring:#2a2c31; }
        html, body { height: 100%; margin: 0; }
        body { background: radial-gradient(1000px 600px at 15% -10%, rgba(88,101,242,.08), transparent 50%), var(--bg-900); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .center { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
        .card { width: 420px; background: var(--bg-800); border: 1px solid var(--ring); border-radius: 16px; padding: 22px; box-shadow: 0 16px 40px rgba(0,0,0,.35); backdrop-filter: saturate(120%); }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { flex: 1; text-align: center; padding: 12px; border-radius: 10px; cursor: pointer; background: var(--bg-700); font-weight: 600; }
        .tab.active { background: var(--brand); color: #fff; }
        .title { font-weight: 900; font-size: 22px; margin-bottom: 4px; }
        .subtitle { color: var(--muted); margin-bottom: 12px; }
        .field { display: flex; flex-direction: column; gap: 6px; margin: 12px 0; }
        .input { background: #3a3e45; color: #fff; border: 1px solid #454a52; border-radius: 10px; padding: 12px; outline: none; }
        .btn { background: var(--brand); color: #fff; border: none; border-radius: 12px; padding: 12px; font-weight: 800; cursor: pointer; width: 100%; }
        .btn:hover { filter: brightness(1.05); }
        .muted { color: var(--muted); font-size: 14px; }
        .topbar { position: fixed; top: 0; left: 0; right: 0; height: 56px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; background: rgba(40,43,48,.72); backdrop-filter: blur(6px); border-bottom: 1px solid var(--ring); z-index: 20; }
        .brand { font-weight: 900; letter-spacing: .3px; }
        .nav-links { display: flex; gap: 8px; }
        .link { color: #fff; text-decoration: none; background: #40444b; padding: 8px 12px; border-radius: 10px; font-weight: 700; }
        .error { color: #ff6b6b; font-size: 14px; }
        .success { color: #57F287; font-size: 14px; }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">DcTalk</div>
        <div class="nav-links"><a class="link" href="/main/index.html">Enter App</a><a class="link" href="/main/dm.html">DMs</a></div>
    </div>
    <div class="center" style="margin-top:56px">
    <div class="card">
        <div class="title">Welcome to DcTalk</div>
        <div class="subtitle">Chat, voice and sharing — all in one.</div>
        <div class="tabs">
            <div class="tab active" id="tab-login">Login</div>
            <div class="tab" id="tab-register">Register</div>
        </div>
        <div id="panel-login">
            <div class="field"><label>Username or Display Name</label><input class="input" id="login-username"></div>
            <div class="field"><label>Password</label><input class="input" type="password" id="login-password"></div>
            <button class="btn" id="login-btn">Login</button>
            <div class="muted" id="login-msg"></div>
            <div class="muted" id="sync-msg"></div>
        </div>
        <div id="panel-register" style="display:none">
            <div class="field"><label>Username</label><input class="input" id="reg-username"></div>
            <div class="field"><label>Display Name</label><input class="input" id="reg-display"></div>
            <div class="field"><label>Password</label><input class="input" type="password" id="reg-password"></div>
            <button class="btn" id="reg-btn">Create Account</button>
            <div class="muted" id="reg-msg"></div>
        </div>
    </div>
    </div>
    <script src="/main/supabase.js"></script>
    <script>
        const USERS_KEY = "dc_users";
        const CURRENT_KEY = "dc_current_user";
        const enc = new TextEncoder();
        function hexToBytes(h){ const arr=new Uint8Array(h.length/2); for(let i=0;i<h.length;i+=2){ arr[i/2]=parseInt(h.slice(i,i+2),16); } return arr; }
        function bytesToHex(b){ return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join(""); }
        async function makeSalt(){ const b=new Uint8Array(16); crypto.getRandomValues(b); return bytesToHex(b); }
        async function pbkdf2(password, saltHex, iter=100000){ const key=await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveBits"]); const bits=await crypto.subtle.deriveBits({name:"PBKDF2", salt: hexToBytes(saltHex), iterations: iter, hash: "SHA-256"}, key, 256); return bytesToHex(bits); }
        async function loadUsers(){ try{ const client = await window.initSupabase(); if(client){ const supa = await window.supabaseGetUsers(); if(supa && Object.keys(supa).length>0){ localStorage.setItem(USERS_KEY, JSON.stringify(supa)); return supa; } } const local = localStorage.getItem(USERS_KEY); return local?JSON.parse(local):{}; }catch(e){ return {}; } }
        async function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); const client = await window.initSupabase(); if(client){ const entries = Object.values(u||{}); for(const rec of entries){ await window.supabaseUpsertProfile(rec); } } }
        function setCurrent(u){ localStorage.setItem(CURRENT_KEY, u); }
        function getCurrent(){ return localStorage.getItem(CURRENT_KEY); }
        document.getElementById("tab-login").onclick=()=>{ document.getElementById("tab-login").classList.add("active"); document.getElementById("tab-register").classList.remove("active"); document.getElementById("panel-login").style.display="block"; document.getElementById("panel-register").style.display="none"; };
        document.getElementById("tab-register").onclick=()=>{ document.getElementById("tab-register").classList.add("active"); document.getElementById("tab-login").classList.remove("active"); document.getElementById("panel-register").style.display="block"; document.getElementById("panel-login").style.display="none"; };
        (async ()=>{ const s=document.getElementById("sync-msg"); const client=await window.initSupabase(); const users=await loadUsers(); const count=Object.keys(users||{}).length; s.textContent=(client?"Cloud Sync On":"Local Only")+" • Accounts: "+count; })();
        document.getElementById("login-btn").onclick=async ()=>{
            const input = document.getElementById("login-username").value.trim();
            const p = document.getElementById("login-password").value;
            const msg = document.getElementById("login-msg");
            msg.textContent="";
            const users=await loadUsers();
            const v=input.toLowerCase();
            let id=null;
            if(users[v]){ id=v; }
            if(!id){
                for(const k in users){ const rec=users[k]; if(k.toLowerCase()===v){ id=k; break; } if(rec && rec.displayName && rec.displayName.toLowerCase()===v){ id=k; break; } }
            }
            if(!id){ msg.textContent="User not found"; msg.className="error"; return; }
            let ok=false;
            const client=await window.initSupabase();
            if(client){ const auth = await window.supabaseGetAuthForUser(id); if(auth && auth.salt && auth.passwordHash){ const h2=await pbkdf2(p, auth.salt); ok=(h2===auth.passwordHash); } }
            else {
              const rec=users[id];
              if(rec && rec.salt && rec.passwordHash){ const h2=await pbkdf2(p, rec.salt); ok=(h2===rec.passwordHash); }
              else if(rec && rec.password){ const hLegacy=await crypto.subtle.digest("SHA-256", enc.encode(p)); const hexLegacy=bytesToHex(hLegacy); ok=(hexLegacy===rec.password); if(ok){ const salt=await makeSalt(); const newHash=await pbkdf2(p, salt); await window.supabaseUpsertUser({ username:id, displayName:rec.displayName, passwordHash:newHash, salt }); delete rec.password; users[id]={ username:id, displayName:rec.displayName, friends:rec.friends||[], incomingRequests:rec.incomingRequests||[], outgoingRequests:rec.outgoingRequests||[], blocked:rec.blocked||[], online:true }; await saveUsers(users); } }
            }
            if(!ok){ msg.textContent="Invalid password"; msg.className="error"; return; }
            setCurrent(id);
            msg.textContent="Login successful"; msg.className="success";
            location.href="/main/index.html";
        };
        document.getElementById("reg-btn").onclick=async ()=>{
            const u = document.getElementById("reg-username").value.trim();
            const d = document.getElementById("reg-display").value.trim();
            const p = document.getElementById("reg-password").value;
            const msg = document.getElementById("reg-msg");
            msg.textContent="";
            if(!u || !d || !p){ msg.textContent="All fields required"; msg.className="error"; return; }
            const users=await loadUsers();
            if(users[u]){ msg.textContent="Username already exists"; msg.className="error"; return; }
            for(const k in users){ if(users[k] && users[k].displayName && users[k].displayName.toLowerCase()===d.toLowerCase()){ msg.textContent="Display name already taken"; msg.className="error"; return; } }
            const salt=await makeSalt();
            const ph=await pbkdf2(p, salt);
            await window.supabaseUpsertUser({ username:u, displayName:d, passwordHash:ph, salt });
            users[u]={ username:u, displayName:d, friends:[], incomingRequests:[], outgoingRequests:[], blocked:[], online:true };
            await saveUsers(users);
            setCurrent(u);
            msg.textContent="Account created"; msg.className="success";
            location.href="/main/index.html";
        };
        if(getCurrent()){ location.href="/main/index.html"; }
    </script>
</body>
</html>
